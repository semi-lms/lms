<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.lms.mapper.AttendanceMapper">

    <!-- 오늘 출석현황 (그대로) -->
    <select id="getTodayAttendance" resultType="com.example.lms.dto.AttendanceDTO">
        SELECT
            SUBSTRING(c.course_name, 1, 3) AS courseName,
            COUNT(*) AS total,
            SUM(CASE WHEN a.status IN('출석', '지각', '조퇴') THEN 1 ELSE 0 END) AS attended
        FROM attendance AS a
        INNER JOIN course AS c ON a.course_id = c.course_id
        WHERE DATE = CURDATE()
        GROUP BY a.course_id, courseName
        ORDER BY a.course_id;
    </select>

    <!-- 학생(본인) 출석 현황 (그대로) -->
    <select id="selectAttendanceListByStudentId" resultType="com.example.lms.dto.AttendanceDTO">
        SELECT attendance_no AS attendanceNo, student_no AS studentNo, course_id AS courseId, DATE, STATUS
        FROM attendance
        WHERE student_no = #{studentNo}
    </select>

    <!-- 전체 출석 레코드 수 (강의별) -->
    <select id="getAttendanceCount" parameterType="int" resultType="int">
        SELECT COUNT(*) FROM attendance WHERE course_id = #{courseId}
    </select>

    <!-- 전체 학생 수 (강의별) -->
    <select id="getStudentCount" parameterType="int" resultType="int">
        SELECT COUNT(*) FROM student WHERE course_id = #{courseId}
    </select>

    <!-- 전체 출석 가능 횟수 (강의별) -->
    <select id="getAttendanceTotalCount" parameterType="map" resultType="int">
        WITH RECURSIVE calendar AS (
            SELECT DATE(#{startDate}) AS dt
            UNION ALL
            SELECT dt + INTERVAL 1 DAY
            FROM calendar
            WHERE dt + INTERVAL 1 DAY &lt; #{endDate}
        ),
        workdays AS (
            SELECT COUNT(*) AS day_count
            FROM calendar
            WHERE DAYOFWEEK(dt) BETWEEN 2 AND 6
              AND dt NOT IN (SELECT date FROM holidays)
        )
        SELECT w.day_count * #{studentCount}
        FROM workdays w
    </select>

    <!-- 실제 출석(지각 포함, 강의별) -->
    <select id="getActualAttendance" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM attendance
        WHERE date BETWEEN #{startDate} AND #{endDate}
          AND (status = '출석' OR status = '지각')
          AND course_id = #{courseId}
    </select>
</mapper>