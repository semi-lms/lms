<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.lms.mapper.AttendanceMapper">
	<select id="getTodayAttendance"
		resultType="com.example.lms.dto.AttendanceDTO">
		SELECT
		SUBSTRING(c.course_name, 1, 3) AS courseName,  <!-- 과정 이름 추출 -->
		COUNT(*) AS total,							   <!-- 반별 전체 학생 수 -->
		SUM(CASE WHEN a.status IN('출석', '지각', '조퇴') THEN 1 ELSE 0 END) AS
		attended  <!-- 출석한 학생 수 -->
		FROM attendance AS a
		INNER JOIN course AS c
		ON a.course_id = c.course_id
		WHERE DATE = CURDATE()  <!-- 오늘 날짜만 조회 -->
		GROUP BY a.course_id, courseName
		ORDER BY a.course_id;
	</select>
	<!-- 학생(본인) 출석 현황 -->
	<select id="selectAttendanceListByStudentId" parameterType="map"
		resultType="com.example.lms.dto.AttendanceDTO">
		SELECT attendance_no AS attendanceNo , student_no AS
		studentNo , course_id
		AS courseId , DATE , STATUS
		FROM attendance
		WHERE
		student_id = #{studentId}
	</select>

       <!-- 전체 출석 레코드 수 -->
    <select id="getAttendanceCount" resultType="int">
        SELECT COUNT(*) FROM attendance
    </select>

    <!-- 전체 학생 수 -->
    <select id="getStudentCount" resultType="int">
        SELECT COUNT(*) FROM student
    </select>

    <!-- 전체 출석 가능 횟수 (월별) -->
    <select id="getAttendanceTotalCount" parameterType="map" resultType="int">
        WITH RECURSIVE calendar AS (
            SELECT DATE(#{startDate}) AS dt
            UNION ALL
            SELECT dt + INTERVAL 1 DAY
            FROM calendar
            WHERE dt + INTERVAL 1 DAY &lt; #{endDate}
        ),
        workdays AS (
            SELECT COUNT(*) AS day_count
            FROM calendar
            WHERE DAYOFWEEK(dt) BETWEEN 2 AND 6
              AND dt NOT IN (SELECT date FROM holidays)
        )
        SELECT w.day_count * #{studentCount}
        FROM workdays w
    </select>

    <!-- 실제 출석(지각 포함) -->
    <select id="getActualAttendance" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM attendance
        WHERE date BETWEEN #{startDate} AND #{endDate}
          AND (status = '출석' OR status = '지각')
    </select>
</mapper>